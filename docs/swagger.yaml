openapi: 3.0.0
info:
  title: Devices Continuous Behavioural Authentication (DCBA) Mechanisms API
  version: 1.0.0
  description: |
    API documentation for the DCBA Services.

    The **Authenticator Endpoints** are exclusively utilized by the Android application, 'Authenticator', which is deployed on employees' devices. 

    To interact with the **GET** endpoints of the **Service API Endpoints**, you must authorize first using a JWT Authorization token:
    1. Click the **Authorize** button at the top-right of this page.
    2. Paste your JWT token without the word "Bearer".
    3. Click **Authorize** and close the dialog.
    4. You can now make authorized requests using the **Try it out** button below.

    **Note**: Currently, the server is not deployed but will be available in the future at the URL specified in the servers section. Therefore, the **Try it out** option is not available right now.

servers:
  - url: https://tango-eu-project.github.io/DCBA-Mechanisms/

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

paths:
  # Service API Endpoints #

  # [1] GET /devices
  /devices:
    get:
      tags:
        - Service API Endpoints  # Tag for service-facing endpoints
      summary: Fetch all devices
      description: Retrieves all device entries from the database. This route requires a valid JWT Bearer token in the Authorization header to access.
      security:
        - BearerAuth: []  # Requires Bearer token in Authorization header
      responses:
        '200':
          description: Successfully fetched devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Devices fetched successfully."
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        device_id:
                          type: string
                          example: "a4e4cf21ab7e"
                        did:
                          type: string
                          example: "did:example:123456789abcdefghi"
                        sub:
                          type: string
                          example: "user@example.com"
        '401':
          description: Authorization token is missing or malformed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              examples:
                MissingAuthorizationToken:
                  summary: Missing Authorization header
                  value:
                    status: "failed"
                    message: "Authorization token is missing."
                MalformedAuthorizationToken:
                  summary: Malformed Authorization header
                  value:
                    status: "failed"
                    message: "Authorization token is malformed. It should start with 'Bearer '."
        '403':
          description: Unauthorized - Authorization token is invalid or expired
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              examples:
                ExpiredToken:
                  summary: Token has expired
                  value:
                    status: "failed"
                    message: "Authorization token has expired."
                InvalidToken:
                  summary: Token is invalid
                  value:
                    status: "failed"
                    message: "Invalid Authorization token."
        '500':
          description: Internal server error while fetching devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Error fetching device data."




  # [2] GET /devices/online-shifts  
  /devices/online-shifts:
    get:
      tags:
        - Service API Endpoints  # Tag for service-facing endpoints
      summary: Fetch online devices
      description: Retrieves devices that are currently online. This route requires a valid JWT Bearer token in the Authorization header to access.
      security:
        - BearerAuth: []  # This specifies that the request requires a Bearer token
      responses:
        '200':
          description: Successfully fetched online devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Fetched online devices successfully."
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        device_id:
                          type: string
                          example: "a4e4cf21ab7e"
                        did:
                          type: string
                          example: "did:example:123456789abcdefghi"
                        sub:
                          type: string
                          example: "user@example.com"
        '401':
          description: Authorization token is missing or malformed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              examples:
                MissingAuthorizationToken:
                  summary: Missing Authorization header
                  value:
                    status: "failed"
                    message: "Authorization token is missing."
                MalformedAuthorizationToken:
                  summary: Malformed Authorization header
                  value:
                    status: "failed"
                    message: "Authorization token is malformed. It should start with 'Bearer '."
        '403':
          description: Unauthorized - Authorization token is invalid or expired
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              examples:
                ExpiredToken:
                  summary: Token has expired
                  value:
                    status: "failed"
                    message: "Authorization token has expired."
                InvalidToken:
                  summary: Token is invalid
                  value:
                    status: "failed"
                    message: "Invalid Authorization token."
        '500':
          description: Internal server error while fetching online devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Error fetching online devices."





  # [3] GET /devices/offline-shifts
  /devices/offline-shifts:
    get:
      tags:
        - Service API Endpoints
      summary: Fetch offline devices
      description: Retrieves devices that are currently offline. This route requires a valid JWT Bearer token in the Authorization header to access.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully fetched offline devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Fetched offline devices successfully."
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        device_id:
                          type: string
                          example: "b7f2de59c8e1"
                        did:
                          type: string
                          example: "did:example:987654321zyxwvu"
                        sub:
                          type: string
                          example: "anotheruser@example.com"
        '401':
          description: Authorization token is missing or malformed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              examples:
                MissingAuthorizationToken:
                  summary: Missing Authorization header
                  value:
                    status: "failed"
                    message: "Authorization token is missing."
                MalformedAuthorizationToken:
                  summary: Malformed Authorization header
                  value:
                    status: "failed"
                    message: "Authorization token is malformed. It should start with 'Bearer '."
        '403':
          description: Unauthorized - Authorization token is invalid or expired
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              examples:
                ExpiredToken:
                  summary: Token has expired
                  value:
                    status: "failed"
                    message: "Authorization token has expired."
                InvalidToken:
                  summary: Token is invalid
                  value:
                    status: "failed"
                    message: "Invalid Authorization token."
        '500':
          description: Internal server error while fetching offline devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Error fetching offline devices."


  # [4] POST /devices/behavioural-score
  /devices/behavioural-score:
    post:
      tags:
        - Service API Endpoints
      summary: Retrieve device behavioural score
      description: >
        Returns the behavioural score of a device based on provided DIDs.
        Requires a valid JWT authorization token passed in the request body.
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - didSP
                - didRequester
                - jwtAuth
              properties:
                didSP:
                  type: string
                  example: "did:example:serviceprovider123"
                didRequester:
                  type: string
                  example: "did:example:device456"
                jwtAuth:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

            examples:
              validRequest:
                summary: Valid request example
                value:
                  didSP: "did:example:serviceprovider123"
                  didRequester: "did:example:device456"
                  jwtAuth: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Behavioural score retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Device found."
                  behaviouralScore:
                    type: number
                    format: float
                    example: 0.85
        '400':
          description: Bad Request - Missing required fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Missing required fields: didSP, didRequester, or jwtAuth."
        '401':
          description: Unauthorized - Authorization token is invalid or expired
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
              examples:
                TokenExpired:
                  summary: Token has expired
                  value:
                    status: "failed"
                    message: "Authorization token has expired."
                InvalidToken:
                  summary: Token is invalid
                  value:
                    status: "failed"
                    message: "Invalid authorization token."
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Device not found."
        '500':
          description: Internal server error while retrieving behavioural score 
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Error retrieving behavioural score."

  # [5] POST /devices/last-location
  /devices/last-location:
    post:
      tags:
        - Service API Endpoints
      summary: Retrieve device last known coordinates
      description: >
        Returns the last known geographic coordinates (latitude and longitude) of a device
        based on provided DIDs.
        Requires a valid JWT authorization token passed in the request body.
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - didSP
                - didRequester
                - jwtAuth
              properties:
                didSP:
                  type: string
                  example: "did:example:serviceprovider123"
                didRequester:
                  type: string
                  example: "did:example:device456"
                jwtAuth:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            examples:
              validRequest:
                summary: Valid request example
                value:
                  didSP: "did:example:serviceprovider123"
                  didRequester: "did:example:device456"
                  jwtAuth: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Last known coordinates retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Device found."
                  lastCoordinates:
                    type: object
                    properties:
                      latitude:
                        type: number
                        format: float
                        example: 39.365858279847544
                      longitude:
                        type: number
                        format: float
                        example: 22.923886333496505
        '400':
          description: Bad Request - Missing required fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Missing required fields: didSP, didRequester, or jwtAuth."
        '401':
          description: Unauthorized - Authorization token is invalid or expired
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Authorization error message"
              examples:
                TokenExpired:
                  summary: Token has expired
                  value:
                    status: "failed"
                    message: "Authorization token has expired."
                InvalidToken:
                  summary: Token is invalid
                  value:
                    status: "failed"
                    message: "Invalid authorization token."

        '404':
          description: Device not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Device not found."
        '500':
          description: Internal server error while retrieving last coordinates
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "failed"
                  message:
                    type: string
                    example: "Error retrieving last coordinates."

  # Service API Endpoints # 
















































  # Authenticator Endpoints #

  /devices/begin-session:
    post:
      summary: Handle device initiation process (QR SCANNER)
      description: This endpoint initiates a device session request. It consistently returns an **HTTP 200** status code, regardless of the operation result, to maintain client-side stability. The success or failure is indicated inside the JSON `status` field.
      tags:
        - Authenticator Endpoints
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - device_id
                - qr_scanner_state_request
                - log_file_uri
              properties:
                device_id:
                  type: string
                  description: The ID of the device initiating the session.
                  example: DEVICE123
                qr_scanner_state_request:
                  type: string
                  description: The state parameter for QR scanner.
                  example: state123
                log_file_uri:
                  type: string
                  description: Optional log file URI.
                  example: https://example.com/logfile.log
      responses:
        '200':
          description: Always returns 200. Check the `status` field in the response body.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [success, failed]
                  message:
                    type: string
                  deviceAuthQRCode:
                    type: string
                    description: The QR code (only on success).
                  sessionRequest:
                    type: object
                    description: Saved session request data (only on success).
              examples:
                Success:
                  summary: Successful QR code generation
                  value:
                    status: success
                    message: QR Code generated successfully.
                    deviceAuthQRCode: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA..."
                    sessionRequest:
                      device_id: "DEVICE123"
                      qr_scanner_state_request: "state123"
                      log_file_uri: "https://example.com/logfile.log"
                      createdAt: "2025-04-26T12:34:56.789Z"
                MissingDeviceID:
                  summary: Missing device_id
                  value:
                    status: failed
                    message: Device ID is missing, session request failed.
                MissingQrScannerState:
                  summary: Missing qr_scanner_state_request
                  value:
                    status: failed
                    message: QR scanner state request is missing, session request failed.
                CertificateReadError:
                  summary: Error reading the certificate file
                  value:
                    status: failed
                    message: Error reading the certificate, proceeding with limited access.
                QrCodeNotFound:
                  summary: QR code not found
                  value:
                    status: failed
                    message: QR code not found, but session continues without it.
                ExtractQrCodeError:
                  summary: Error extracting QR code
                  value:
                    status: failed
                    message: Failed to extract QR code, but session is still active.
                SessionHandlingError:
                  summary: Error handling session request
                  value:
                    status: failed
                    message: Error handling session request, but proceeding with the process.

  # Authenticator Endpoints #